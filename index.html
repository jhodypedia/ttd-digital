<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tanda Tangan Digital</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .signature-container {
      max-width: 700px;
      margin: auto;
    }
    .signature-pad {
      width: 100%;
      height: 300px;
      border: 2px dashed #6c757d;
      border-radius: 8px;
      background-color: #ffffff;
      touch-action: none;
    }
    @media (max-width: 576px) {
      .signature-pad {
        height: 250px;
      }
    }
  </style>
</head>
<body>

<div class="container py-5">
  <div class="signature-container text-center">
    <h3 class="mb-4">Tanda Tangan Digital</h3>

    <div class="mb-3 row">
      <div class="col-md-6 mb-2">
        <input type="text" id="nama" class="form-control" placeholder="Masukkan Nama (opsional)">
      </div>
      <div class="col-md-6">
        <input type="date" id="tanggal" class="form-control" placeholder="Tanggal (opsional)">
      </div>
    </div>

    <div class="card shadow p-3">
      <canvas id="signature" class="signature-pad"></canvas>
      <div class="mt-3 d-flex flex-wrap justify-content-center gap-2">
        <button class="btn btn-danger" onclick="clearSignature()">Hapus</button>
        <button class="btn btn-success" onclick="downloadSignature()">Download PNG</button>
        <button class="btn btn-primary" onclick="printSignature()">Cetak</button>
      </div>
    </div>
  </div>
</div>

<script>
  const canvas = document.getElementById("signature");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
  }

  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function getPointerPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) {
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top
      };
    } else {
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }
  }

  function startPosition(e) {
    drawing = true;
    draw(e);
  }

  function endPosition() {
    drawing = false;
    ctx.beginPath();
  }

  function draw(e) {
    if (!drawing) return;
    const pos = getPointerPos(e);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  // Mouse Events
  canvas.addEventListener("mousedown", startPosition);
  canvas.addEventListener("mouseup", endPosition);
  canvas.addEventListener("mousemove", draw);

  // Touch Events
  canvas.addEventListener("touchstart", function(e) {
    e.preventDefault();
    startPosition(e);
  }, { passive: false });

  canvas.addEventListener("touchend", function(e) {
    e.preventDefault();
    endPosition();
  }, { passive: false });

  canvas.addEventListener("touchmove", function(e) {
    e.preventDefault();
    draw(e);
  }, { passive: false });

  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    resizeCanvas();
  }

  function generateRandomFilename() {
    const timestamp = Date.now();
    const randomNum = Math.floor(Math.random() * 100000);
    return `tanda_tangan_${timestamp}_${randomNum}.png`;
  }

  function drawTextOverlay() {
    const nama = document.getElementById("nama").value.trim();
    const tanggal = document.getElementById("tanggal").value;
    const text = `${nama ? nama : ''} ${nama && tanggal ? ' - ' : ''}${tanggal ? formatTanggal(tanggal) : ''}`;

    if (text !== "") {
      ctx.font = "16px Segoe UI";
      ctx.fillStyle = "#333";
      ctx.textAlign = "center";
      ctx.fillText(text, canvas.width / 2, canvas.height - 20);
    }
  }

  function formatTanggal(tgl) {
    const date = new Date(tgl);
    return date.toLocaleDateString("id-ID", { year: 'numeric', month: 'long', day: 'numeric' });
  }

  function downloadSignature() {
    const tempCanvas = document.createElement("canvas");
    const tempCtx = tempCanvas.getContext("2d");

    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    tempCtx.drawImage(canvas, 0, 0);

    // Gambar ulang teks overlay (nama/tanggal)
    const nama = document.getElementById("nama").value.trim();
    const tanggal = document.getElementById("tanggal").value;
    const text = `${nama ? nama : ''} ${nama && tanggal ? ' - ' : ''}${tanggal ? formatTanggal(tanggal) : ''}`;

    if (text !== "") {
      tempCtx.font = "16px Segoe UI";
      tempCtx.fillStyle = "#333";
      tempCtx.textAlign = "center";
      tempCtx.fillText(text, tempCanvas.width / 2, tempCanvas.height - 20);
    }

    const link = document.createElement("a");
    link.download = generateRandomFilename();
    link.href = tempCanvas.toDataURL("image/png");
    link.click();
  }

  function printSignature() {
    const nama = document.getElementById("nama").value.trim();
    const tanggal = document.getElementById("tanggal").value;

    const tempCanvas = document.createElement("canvas");
    const tempCtx = tempCanvas.getContext("2d");

    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    tempCtx.drawImage(canvas, 0, 0);

    if (nama || tanggal) {
      const text = `${nama ? nama : ''} ${nama && tanggal ? ' - ' : ''}${tanggal ? formatTanggal(tanggal) : ''}`;
      tempCtx.font = "16px Segoe UI";
      tempCtx.fillStyle = "#333";
      tempCtx.textAlign = "center";
      tempCtx.fillText(text, tempCanvas.width / 2, tempCanvas.height - 20);
    }

    const imageData = tempCanvas.toDataURL("image/png");
    const win = window.open("");
    win.document.write(`<img src="${imageData}" style="width:100%">`);
    win.document.close();
    win.focus();
    win.print();
    win.close();
  }
</script>

</body>
</html>
